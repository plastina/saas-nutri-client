<p-toast></p-toast>
<p-confirmDialog icon="pi pi-exclamation-triangle"></p-confirmDialog>
<p-toolbar styleClass="app-main-toolbar">
  <div class="toolbar-group-start">
    <span class="toolbar-title">SaaS Nutri</span>
  </div>
</p-toolbar>

<div class="app-layout-container">
  <div class="left-column">
    <div class="meal-add-section">
      <div class="meal-add-controls">
        <h3 class="section-title">Refeições</h3>
        <input
          pInputText
          type="text"
          placeholder="Nova Refeição"
          id="new-meal-name"
          #newMealNameInput
          class="new-meal-input"
        />
        <button
          pButton
          type="button"
          icon="pi pi-plus"
          label="Adicionar"
          styleClass="add-meal-button"
          (click)="addMeal(newMealNameInput.value); newMealNameInput.value = ''"
          aria-label="Adicionar Refeição"
        ></button>
      </div>
      <div class="header-actions">
        <button
          pButton
          type="button"
          label="Exportar Plano (JSON)"
          icon="pi pi-download"
          styleClass="export-plan-btn"
          (click)="exportToJson()"
          [disabled]="!hasItemsInAnyMeal"
          aria-label="Exportar Plano"
        ></button>
        <button
          type="button"
          pButton
          label="Importar Plano (JSON)"
          icon="pi pi-upload"
          styleClass="import-plan-btn"
          (click)="fileImportInput.click()"
          aria-label="Importar Plano"
        ></button>
        <input
          hidden
          type="file"
          id="import-json"
          accept=".json"
          (change)="handleFileInput($event)"
          #fileImportInput
        />
      </div>
    </div>

    <p-divider layout="horizontal" styleClass="section-divider"></p-divider>

    <div class="section-search-container">
      <div class="search-controls">
        <h2 class="section-title">Buscar Alimentos</h2>
        <app-food-search
          (searchTermSubmitted)="handleSearch($event)"
        ></app-food-search>
        <div *ngIf="meals.length > 0" class="meal-selector">
          <p-dropdown
            [options]="meals"
            [(ngModel)]="selectedMealName"
            optionLabel="name"
            optionValue="name"
            placeholder="Selecione a refeição para adicionar"
            styleClass="meal-selector-dropdown"
          />
        </div>
      </div>

      <div class="search-results">
        <div class="results-content">
          <div *ngIf="isLoadingResults" class="spinner-container">
            <p-progressSpinner
              styleClass="loading-spinner"
              strokeWidth="6"
              animationDuration=".5s"
            ></p-progressSpinner>
          </div>
          <app-food-list
            *ngIf="!isLoadingResults"
            [foods]="searchResults"
            (foodSelected)="addFoodToCurrentDiet($event)"
          ></app-food-list>
        </div>
      </div>
    </div>

    <p-divider></p-divider>
  </div>

  <div class="right-column">
    <h2 class="section-title">Plano Alimentar Atual</h2>
    <app-diet-builder
      [meals]="meals"
      (itemRemoved)="handleRemoveFood($event)"
      (quantityChanged)="handleQuantityChange()"
      (mealNameChanged)="handleMealNameChange($event)"
      (mealDeleted)="handleMealDelete($event)"
    ></app-diet-builder>
    <div *ngIf="hasItemsInAnyMeal">
      <p-divider layout="horizontal" styleClass="section-divider"></p-divider>
      <div class="totals">
        <h3 class="section-title">Totais do Plano:</h3>
        <p class="total-item">
          Calorias: {{ totalKcal | number : "1.0-0" }} kcal
        </p>
        <p class="total-item">
          Proteínas: {{ totalProtein | number : "1.1-1" }} g
        </p>
        <p class="total-item">
          Carboidratos: {{ totalCarbs | number : "1.1-1" }} g
        </p>
        <p class="total-item">Gorduras: {{ totalFat | number : "1.1-1" }} g</p>
        <p class="total-item total-item-last">
          Fibras: {{ totalFiber | number : "1.1-1" }} g
        </p>
      </div>
    </div>
  </div>
</div>
